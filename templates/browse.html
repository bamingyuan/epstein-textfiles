{% extends "base.html" %}
{% block title %}Document Browser{% endblock %}
{% block body_class %}browse-page{% endblock %}
{% block page_shell_class %}page-shell-browser{% endblock %}
{% block content %}
<section class="control-panel">
  <form method="get" action="{{ url_for('browse') }}" class="search-form">
    <label for="q">Search</label>
    <input id="q" type="text" name="q" value="{{ q }}" placeholder="Try: meeting minutes OR exact phrase in quotes">

    <label for="dataset">Dataset</label>
    <select id="dataset" name="dataset">
      <option value="">All datasets</option>
      {% for ds in datasets %}
      <option value="{{ ds['dataset'] }}" {% if dataset == ds['dataset'] %}selected{% endif %}>
        {{ ds["dataset"] }} ({{ ds["count"] }})
      </option>
      {% endfor %}
    </select>

    <label for="scope">Search Scope</label>
    <select id="scope" name="scope">
      <option value="current" {% if scope == "current" %}selected{% endif %}>Within current browse period</option>
      <option value="all" {% if scope == "all" %}selected{% endif %}>All documents</option>
    </select>

    <label for="sort">Sort</label>
    <select id="sort" name="sort">
      <option value="relevance" {% if sort == "relevance" %}selected{% endif %}>Relevance</option>
      <option value="date_desc" {% if sort == "date_desc" %}selected{% endif %}>Date newest first</option>
      <option value="date_asc" {% if sort == "date_asc" %}selected{% endif %}>Date oldest first</option>
    </select>

    <input type="hidden" name="year" value="{{ year or '' }}">
    <input type="hidden" name="month" value="{{ month or '' }}">
    <input type="hidden" name="day" value="{{ day or '' }}">
    <input type="hidden" name="undated" value="{{ 1 if undated else '' }}">
    <input type="hidden" name="per_page" value="{{ per_page }}">

    <button type="submit">Apply</button>
  </form>

  <div class="control-notes">
    <p><strong>{{ total }}</strong> documents in current result set.</p>
    <p>
      {% if fts_enabled %}
      Full-text index is available.
      {% else %}
      Full-text index is not initialized yet. Search works, but can be slower.
      {% endif %}
    </p>
  </div>
</section>

<section class="browser-layout">
  <aside class="pane pane-nav">
    <div class="pane-header">
      <h2>Browse By Date</h2>
      <div class="browse-tabs">
        <a href="{{ url_for('browse', q=q or None, dataset=dataset, scope='current', sort=sort, year=year, month=month, day=day, per_page=per_page) }}" class="{% if not undated %}active{% endif %}">Dated</a>
        <a href="{{ url_for('browse', q=q or None, dataset=dataset, scope=scope, sort=sort, undated=1, per_page=per_page) }}" class="{% if undated %}active{% endif %}">Undated</a>
      </div>
    </div>

    {% if not undated %}
    <div class="date-section date-section-years">
      <h3>Years</h3>
      <ul>
        <li>
          <a href="{{ url_for('browse', q=q or None, dataset=dataset, scope='all', sort=sort, per_page=per_page) }}" class="{% if not year and not month and not day %}active{% endif %}">
            All dates
          </a>
        </li>
        {% for y in years %}
        {% set year_active = y['year'] == year %}
        <li>
          <a href="{{ url_for('browse', q=q or None, dataset=dataset, scope='all' if year_active else 'current', sort=sort, year=None if year_active else y['year'], month=None, day=None, per_page=per_page) }}" class="{% if year_active %}active{% endif %}">
            {{ y["year"] }}
          </a>
          <span>{{ y["count"] }}</span>
        </li>
        {% endfor %}
      </ul>
    </div>

    {% if year %}
    <div class="date-section date-section-months">
      <h3>Months</h3>
      <ul>
        {% for m in months %}
        {% set month_active = m['month'] == month %}
        <li>
          <a href="{{ url_for('browse', q=q or None, dataset=dataset, scope='current', sort=sort, year=year, month=None if month_active else m['month'], day=None, per_page=per_page) }}" class="{% if month_active %}active{% endif %}">
            {{ "%02d"|format(m["month"]) }}
          </a>
          <span>{{ m["count"] }}</span>
        </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}

    {% if year and month %}
    <div class="date-section date-section-days">
      <h3>Days</h3>
      <ul>
        {% for d in days %}
        {% set day_active = d['day'] == day %}
        <li>
          <a href="{{ url_for('browse', q=q or None, dataset=dataset, scope='current', sort=sort, year=year, month=month, day=None if day_active else d['day'], per_page=per_page) }}" class="{% if day_active %}active{% endif %}">
            {{ "%02d"|format(d["day"]) }}
          </a>
          <span>{{ d["count"] }}</span>
        </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
    {% else %}
    <div class="date-section">
      <h3>Undated archive</h3>
      <p class="muted">Browsing documents without a valid date.</p>
    </div>
    {% endif %}
  </aside>

  <section class="pane pane-list">
    <div class="pane-header">
      <h2>Document List</h2>
      <p>Page {{ page }} of {{ total_pages }}</p>
    </div>
    <div class="list-scroll">
      {% for row in rows %}
      <article class="doc-row {% if selected_doc_id == row['id'] %}active{% endif %}">
        <a class="doc-row-link" href="{{ url_for('browse', q=q or None, dataset=dataset, scope=scope, sort=sort, year=year, month=month, day=day, undated=1 if undated else None, per_page=per_page, page=page, doc=row['id']) }}">
          <div class="doc-meta">
            {% set row_date = row["date"]|display_date %}
            {% set row_time = row["time"]|display_time %}
            <span class="doc-date">
              {{ row_date or "Undated" }}{% if row_time %} {{ row_time }}{% endif %}
            </span>
            <span class="doc-dataset">{{ row["dataset"] }}</span>
          </div>
          <h3>{{ row["filename"] }}</h3>
          <p>{{ row["content"] or row["preview"] }}</p>
        </a>
      </article>
      {% else %}
      <p class="muted">No documents matched the current filters.</p>
      {% endfor %}
    </div>

    <nav class="pager">
      {% if page > 1 %}
      <a href="{{ url_for('browse', q=q or None, dataset=dataset, scope=scope, sort=sort, year=year, month=month, day=day, undated=1 if undated else None, per_page=per_page, page=page-1, doc=selected_doc_id) }}">Previous</a>
      {% else %}
      <span class="disabled">Previous</span>
      {% endif %}

      {% if page < total_pages %}
      <a href="{{ url_for('browse', q=q or None, dataset=dataset, scope=scope, sort=sort, year=year, month=month, day=day, undated=1 if undated else None, per_page=per_page, page=page+1, doc=selected_doc_id) }}">Next</a>
      {% else %}
      <span class="disabled">Next</span>
      {% endif %}
    </nav>
  </section>

  <aside class="pane pane-preview">
    <div class="pane-header">
      <h2>Preview</h2>
    </div>
    {% if selected_doc %}
    <div class="doc-preview">
      <h3>{{ selected_doc["filename"] }}</h3>
      <dl>
        <dt>ID</dt>
        <dd>{{ selected_doc["id"] }}</dd>
        <dt>Date</dt>
        <dd>{{ selected_doc["date"]|display_date or "Undated" }}</dd>
        <dt>Time</dt>
        <dd>{{ selected_doc["time"]|display_time or "Not available" }}</dd>
        <dt>Dataset</dt>
        <dd>{{ selected_doc["dataset"] }}</dd>
        <dt>Type</dt>
        <dd>{{ selected_doc["type"] or "Not available" }}</dd>
      </dl>
      <p class="actions">
        <a class="button-link" href="{{ selected_doc['url'] }}" target="_blank" rel="noopener noreferrer">Open Original Source</a>
        <a class="button-link secondary" href="{{ url_for('doc_detail', doc_id=selected_doc['id'], back=request.full_path) }}">Open Full View</a>
      </p>
      {% if selected_doc["content"] %}
      <section>
        <h4>Summary</h4>
        <p>{{ selected_doc["content"] }}</p>
      </section>
      {% endif %}
      <section>
        <h4>Message</h4>
        <pre class="preview-message">{{ selected_doc["message"]|highlight_search(q) }}</pre>
      </section>
    </div>
    {% else %}
    <p class="muted">Select a document in the list to preview it.</p>
    {% endif %}
  </aside>
</section>
<script>
  (function () {
    const list = document.querySelector(".list-scroll");
    if (!list) {
      return;
    }

    const keyUrl = new URL(window.location.href);
    keyUrl.searchParams.delete("doc");
    const storageKey = "browse:list-scroll:" + keyUrl.pathname + "?" + keyUrl.searchParams.toString();
    const keyboardNavFlagKey = storageKey + ":keyboard-nav";
    const shouldFocusActiveRow = sessionStorage.getItem(keyboardNavFlagKey) === "1";
    if (shouldFocusActiveRow) {
      sessionStorage.removeItem(keyboardNavFlagKey);
    }

    const savedScrollTop = sessionStorage.getItem(storageKey);
    if (savedScrollTop !== null) {
      const parsed = Number(savedScrollTop);
      if (Number.isFinite(parsed)) {
        requestAnimationFrame(function () {
          list.scrollTop = parsed;
        });
      }
    }

    const saveScroll = function () {
      sessionStorage.setItem(storageKey, String(list.scrollTop));
    };

    if (shouldFocusActiveRow) {
      requestAnimationFrame(function () {
        const activeRow = document.querySelector(".doc-row.active");
        if (!activeRow) {
          return;
        }
        activeRow.scrollIntoView({ block: "center", inline: "nearest" });
        saveScroll();
      });
    }

    list.addEventListener("scroll", saveScroll, { passive: true });
    window.addEventListener("beforeunload", saveScroll);
    document.querySelectorAll(".doc-row-link").forEach(function (link) {
      link.addEventListener("click", saveScroll);
    });

    const links = Array.from(document.querySelectorAll(".doc-row-link"));
    const messagePane = document.querySelector(".preview-message");
    if (!links.length) {
      return;
    }

    const isTypingTarget = function (target) {
      if (!target) {
        return false;
      }
      if (target.isContentEditable) {
        return true;
      }
      const tagName = target.tagName ? target.tagName.toLowerCase() : "";
      return tagName === "input" || tagName === "textarea" || tagName === "select";
    };

    const canPageMessage = function (direction) {
      if (!messagePane) {
        return false;
      }
      if (direction > 0) {
        return messagePane.scrollTop + messagePane.clientHeight < messagePane.scrollHeight - 1;
      }
      return messagePane.scrollTop > 0;
    };

    const pageMessage = function (direction) {
      if (!messagePane) {
        return;
      }
      const amount = Math.max(messagePane.clientHeight - 24, 80);
      messagePane.scrollBy({ top: amount * direction, behavior: "auto" });
    };

    document.addEventListener("keydown", function (event) {
      if (event.defaultPrevented) {
        return;
      }
      if (event.altKey || event.ctrlKey || event.metaKey) {
        return;
      }
      if (isTypingTarget(event.target)) {
        return;
      }

      const isSpace = event.code === "Space" || event.key === " " || event.key === "Spacebar";
      if (isSpace) {
        const direction = event.shiftKey ? -1 : 1;
        if (canPageMessage(direction)) {
          event.preventDefault();
          pageMessage(direction);
        }
        return;
      }
      if (event.key !== "ArrowUp" && event.key !== "ArrowDown") {
        return;
      }

      const activeRow = document.querySelector(".doc-row.active .doc-row-link");
      const activeIndex = activeRow ? links.indexOf(activeRow) : 0;
      const direction = event.key === "ArrowDown" ? 1 : -1;
      const nextIndex = Math.min(Math.max(activeIndex + direction, 0), links.length - 1);

      if (nextIndex === activeIndex) {
        return;
      }

      event.preventDefault();
      sessionStorage.setItem(keyboardNavFlagKey, "1");
      saveScroll();
      window.location.assign(links[nextIndex].href);
    });
  })();
</script>
{% endblock %}
